# app/wecom/client.py
import time, requests
from app.wecom.token import get_access_token

def _post(api_path: str, access_token: str, payload: dict) -> dict:
    url = f"https://qyapi.weixin.qq.com/cgi-bin/{api_path}?access_token={access_token}"
    resp = requests.post(url, json=payload, timeout=10)
    data = resp.json()
    ok = data.get("errcode") == 0
    return {
        "ok": ok,
        "errcode": data.get("errcode"),
        "errmsg": data.get("errmsg"),
        "request_id": resp.headers.get("X-Request-Id")
    }

def send_message(agent_id: int | str, payload: dict, max_retry: int = 3) -> dict:
    for attempt in range(max_retry + 1):
        token = get_access_token(agent_id)
        res = _post("message/send", token, payload)
        if res["ok"]:
            return res
        if res["errcode"] in (45009, 42001) or res["errcode"] >= 500:  # 45009限流；42001 token过期
            time.sleep(min(2 ** attempt, 8))
            continue
        return res
    return res

def recall_message(agent_id: int | str, msgid: str) -> dict:
    token = get_access_token(agent_id)
    return _post("message/recall", token, {"msgid": msgid})
