name: Deploy DEV (wecom_ops_dev)

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

concurrency:
  group: deploy-dev-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to DEV via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key:      ${{ secrets.DEV_KEY }}
          port:     ${{ secrets.DEV_PORT }}
          command_timeout: 20m
          script_stop: true
          script: |
            set -euxo pipefail
            export LANG=C LC_ALL=C

            APP_DIR="/www/wwwroot/wecom_ops_dev"
            SERVICE="wecom_ops_dev"
            BRANCH="develop"

            [ -d "$APP_DIR" ] || { echo "ERROR: $APP_DIR 不存在"; exit 1; }
            cd "$APP_DIR"

            git config --global --add safe.directory "$APP_DIR"
            mkdir -p ~/.ssh && ssh-keyscan -T 5 github.com >> ~/.ssh/known_hosts 2>/dev/null || true

            # 关键修改：用单行短路表达式，避免逐行执行时把测试命令当失败
            [ -d .git ] \
              && git remote set-url origin git@github.com:eddy7956/wecom.git \
              || { git init && git remote add origin git@github.com:eddy7956/wecom.git; }

            git fetch origin "$BRANCH" --depth=1
            git checkout -B "$BRANCH"
            git reset --hard "origin/$BRANCH"

            command -v python3
            [ -d .venv ] || python3 -m venv .venv
            ./.venv/bin/pip install -U pip
            [ -f requirements.txt ] && ./.venv/bin/pip install -r requirements.txt || true

            systemctl restart "$SERVICE"

            # 内部健康检查（最多 30 次 * 2s）
            for i in $(seq 1 30); do
              curl -fsS http://127.0.0.1:5002/healthz >/dev/null 2>&1 && break || true
              curl -fsS http://127.0.0.1:5002/api/v1/health >/dev/null 2>&1 && break || true
              sleep 2
            done

            systemctl is-active --quiet "$SERVICE" || { echo "DEV 服务未就绪"; exit 1; }
            ss -lntp | egrep '127\.0\.0\.1:(5002|5082)' || true

      - name: Public smoke (DEV)
        run: |
          set -euxo pipefail
          curl -fsS -m 10 https://wework.yfsports.com.cn/dev-api/v1/health | tee /tmp/dev_resp.json
          grep -q '"ok":true' /tmp/dev_resp.json
