# 标准上线清单（WeCom Ops）

## 适用范围
- 仓库：eddy7956/wecom
- 分支策略：develop（测试/5002）、main（生产/5001）
- SSOT：仅 GitHub 为真相源；服务器只拉代码；`.env` 等环境差异仅在服务器

## 上线前通用检查
- [ ] 需求/缺陷单已关闭并有验收记录
- [ ] 自测通过（关键接口截图/日志）
- [ ] 无破坏性 SQL；如有 DDL/数据迁移，附回滚脚本
- [ ] 配置变更比对完毕：不把 `.env` 写进仓库
- [ ] 回滚点选定（目标 commit SHA），`rollback-prod.yml` 已可执行

## DEV 发版（develop → 5002）
- [ ] 推送 develop：`git push origin develop`
- [ ] 等待 **deploy-dev.yml** 完成（日志：拉取→依赖→重启→健康）
- [ ] 冒烟（内网）：`curl -fsS http://127.0.0.1:5002/healthz`
- [ ] 冒烟（公网）：`curl -fsS https://wework.yfsports.com.cn/dev-api/v1/health | grep '"ok":true'`

## PROD 发版（main → 5001）
- [ ] 合并：`git checkout main && git merge --no-ff develop && git push origin main`
- [ ] 等待 **deploy-prod.yml** 完成
- [ ] 冒烟（内网）：`curl -fsS http://127.0.0.1:5001/healthz`
- [ ] 冒烟（公网）：`curl -fsS https://wework.yfsports.com.cn/api/v1/health | grep '"ok":true'`

## 回滚
- [ ] GitHub 触发 **rollback-prod.yml**，输入目标回滚 SHA
- [ ] 复核公网冒烟返回 `"ok":true`
- [ ] 记录回滚时间、责任人、原因、修复计划

## 运维记录（必须）
- [ ] 发版编号/时间/人
- [ ] 分支与 commit（develop/main & SHA）
- [ ] 改动清单/SQL 脚本路径
- [ ] 冒烟截图或日志片段
- [ ] 回滚点（如需要）

## 常见故障速查
- **Actions SSH 拒绝**：核对 `host/username/key/port`；服务器 22 放行；`ss -lntp | grep :22`
- **origin 不存在**：本地/服务器执行 `git remote add origin git@github.com:eddy7956/wecom.git`
- **服务未就绪**：`journalctl -u wecom_ops{_dev} -n 200` 看 Python 栈；确认 `.env` 不缺关键变量
- **公网 4xx/5xx**：`nginx -t && systemctl reload nginx`；查 `/www/wwwlogs/wework.yfsports.com.cn.log` 末 50 行
